# 小说视频生成系统架构设计

## 系统概述

小说视频生成系统是一个基于AI的多模态内容生成平台，能够将小说文本转换为高质量的视频内容。系统采用模块化设计，支持高并发处理和批量任务管理。

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                    用户接口层                                │
├─────────────────────────────────────────────────────────────┤
│  CLI接口  │  API接口  │  交互模式  │  批量处理  │  监控界面  │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                    任务调度层                                │
├─────────────────────────────────────────────────────────────┤
│  任务调度器  │  任务队列  │  工作线程池  │  任务监控  │  重试机制  │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                    业务处理层                                │
├─────────────────────────────────────────────────────────────┤
│  小说处理器  │  视频处理器  │  分镜处理器  │  素材管理器  │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                    服务接口层                                │
├─────────────────────────────────────────────────────────────┤
│ DeepSeek服务 │ TTS服务 │ 图像生成服务 │ 视频生成服务 │ 文件服务 │
└─────────────────────────────────────────────────────────────┘
                                │
┌─────────────────────────────────────────────────────────────┐
│                    基础设施层                                │
├─────────────────────────────────────────────────────────────┤
│  配置管理  │  日志管理  │  数据库管理  │  文件管理  │  缓存管理  │
└─────────────────────────────────────────────────────────────┘
```

## 核心模块设计

### 1. 配置管理模块 (src/core/config.py)

**职责**：
- 加载和管理系统配置
- 支持环境变量覆盖
- 自动创建必要目录

**设计特点**：
- 分层配置结构
- 环境变量支持
- 配置验证和默认值

```python
class ConfigManager:
    def get(self, key: str, default: Any = None) -> Any
    def set(self, key: str, value: Any)
    def get_path(self, path_key: str) -> Path
    def reload(self)
```

### 2. 日志管理模块 (src/core/logger.py)

**职责**：
- 统一的日志记录
- 多级别日志输出
- 日志轮转和压缩

**设计特点**：
- 结构化日志格式
- 文件和控制台输出
- 错误日志分离

```python
class LoggerManager:
    def log_task_start(self, task_id: str, task_type: str, **kwargs)
    def log_task_complete(self, task_id: str, task_type: str, duration: float, **kwargs)
    def log_api_call(self, service: str, endpoint: str, status: str, duration: float, **kwargs)
```

### 3. 数据库管理模块 (src/core/database.py)

**职责**：
- 任务状态持久化
- 文件信息管理
- API调用记录

**设计特点**：
- SQLite数据库
- 事务支持
- 数据完整性

```sql
-- 主要数据表
tasks (任务表)
storyboards (分镜脚本表)
files (文件信息表)
api_calls (API调用记录表)
```

### 4. 任务调度模块 (src/scheduler/)

**职责**：
- 任务队列管理
- 并发控制
- 任务监控和重试

**设计特点**：
- 多线程工作池
- 任务优先级
- 超时和重试机制

```python
class TaskScheduler:
    def submit_task(self, task_type: str, input_file: str, config_data: Dict) -> str
    def get_task_status(self, task_id: str) -> Optional[Dict]
    def retry_task(self, task_id: str) -> bool
    def cancel_task(self, task_id: str) -> bool
```

### 5. 服务接口模块 (src/services/)

**职责**：
- 外部API调用
- 数据格式转换
- 错误处理和重试

**设计特点**：
- 统一的API接口
- 异步调用支持
- 请求签名和认证

```python
# 服务基类
class VolcengineService:
    def _make_request(self, method: str, endpoint: str, data: Dict) -> Dict
    def _poll_task_status(self, task_id: str, poll_url: str) -> Dict
    def _download_file(self, url: str, local_path: str) -> bool

# 具体服务
class DeepSeekService:    # 小说分析
class TTSService:         # 文本转语音
class ImageGenService:    # 图像生成
class VideoGenService:    # 视频生成
```

### 6. 处理器模块 (src/processors/)

**职责**：
- 业务逻辑处理
- 数据流控制
- 结果整合

**设计特点**：
- 模块化设计
- 可扩展架构
- 错误隔离

```python
class NovelProcessor:
    def process_novel(self, task_id: str, input_file: str, config_data: Dict) -> bool
    def _generate_scene_assets(self, task_id: str, storyboard: Dict) -> Dict
    def _create_scene_videos(self, task_id: str, scene_assets: Dict) -> List[str]
    def _merge_final_video(self, task_id: str, scene_videos: List[str]) -> str
```

## 数据流设计

### 1. 任务提交流程

```
用户提交任务 → 任务调度器 → 任务队列 → 工作线程 → 业务处理器
```

### 2. 视频生成流程

```
小说文本 → DeepSeek分析 → 分镜脚本 → 素材生成 → 视频合成 → 最终输出
                ↓              ↓           ↓           ↓
            TTS音频生成    图像生成    视频生成    视频合并
```

### 3. 错误处理流程

```
任务执行 → 错误检测 → 错误分类 → 重试决策 → 重试执行 → 结果验证
```

## 并发设计

### 1. 多线程架构

- **主线程**：用户交互和任务提交
- **调度线程**：任务分发和状态监控
- **工作线程池**：并发执行任务
- **监控线程**：系统状态监控

### 2. 并发控制

- **任务队列**：线程安全的队列实现
- **资源锁**：数据库和文件访问同步
- **信号量**：API调用频率限制

### 3. 负载均衡

- **任务分配**：轮询或优先级分配
- **资源监控**：CPU、内存、磁盘使用率
- **动态调整**：根据负载调整并发数

## 存储设计

### 1. 文件存储结构

```
data/
├── input/          # 输入文件
├── output/         # 输出文件
├── temp/           # 临时文件
│   └── {task_id}/  # 任务临时文件
│       ├── audio/  # 音频文件
│       ├── images/ # 图像文件
│       └── videos/ # 视频文件
└── database/       # 数据库文件
```

### 2. 数据库设计

- **任务表**：任务状态和元数据
- **分镜表**：分镜脚本和素材路径
- **文件表**：文件信息和校验和
- **API表**：调用记录和性能统计

### 3. 缓存策略

- **内存缓存**：配置和会话数据
- **文件缓存**：临时生成的文件
- **清理策略**：自动清理过期文件

## 安全设计

### 1. API安全

- **认证机制**：API密钥和签名验证
- **访问控制**：基于角色的权限控制
- **请求限制**：频率限制和配额管理

### 2. 数据安全

- **文件校验**：MD5/SHA256校验和
- **访问日志**：完整的操作审计
- **数据备份**：定期备份重要数据

### 3. 系统安全

- **错误处理**：避免敏感信息泄露
- **资源限制**：防止资源耗尽攻击
- **日志脱敏**：敏感信息脱敏处理

## 监控和运维

### 1. 性能监控

- **任务监控**：执行时间和成功率
- **资源监控**：CPU、内存、磁盘使用
- **API监控**：调用频率和响应时间

### 2. 日志分析

- **错误分析**：错误类型和频率统计
- **性能分析**：瓶颈识别和优化建议
- **用户行为**：使用模式和趋势分析

### 3. 告警机制

- **阈值告警**：资源使用率告警
- **异常告警**：错误率异常告警
- **业务告警**：任务失败告警

## 扩展性设计

### 1. 水平扩展

- **服务分离**：不同服务独立部署
- **负载均衡**：多实例负载分担
- **数据分片**：数据库分片和读写分离

### 2. 垂直扩展

- **模块化设计**：功能模块独立升级
- **插件机制**：支持第三方插件
- **配置驱动**：通过配置调整行为

### 3. 功能扩展

- **新服务支持**：易于添加新的AI服务
- **格式扩展**：支持更多输入输出格式
- **算法优化**：支持算法升级和替换

## 部署架构

### 1. 单机部署

```
┌─────────────────────────────────────┐
│           应用服务器                │
├─────────────────────────────────────┤
│  主程序  │  调度器  │  工作线程池  │
├─────────────────────────────────────┤
│  数据库  │  文件系统  │  日志系统  │
└─────────────────────────────────────┘
```

### 2. 分布式部署

```
┌─────────────────┐  ┌─────────────────┐
│   负载均衡器    │  │   监控服务器    │
└─────────────────┘  └─────────────────┘
         │                      │
┌─────────────────┐  ┌─────────────────┐
│   应用服务器1   │  │   应用服务器2   │
└─────────────────┘  └─────────────────┘
         │                      │
┌─────────────────────────────────────┐
│           共享存储系统              │
│  数据库集群  │  文件存储  │  缓存   │
└─────────────────────────────────────┘
```

## 总结

本系统采用分层架构设计，具有以下特点：

1. **模块化**：各模块职责清晰，易于维护和扩展
2. **可扩展**：支持水平扩展和垂直扩展
3. **高可用**：完善的错误处理和重试机制
4. **可监控**：全面的监控和日志系统
5. **易部署**：支持单机和分布式部署

通过这种架构设计，系统能够高效地处理大量小说视频生成任务，同时保持良好的可维护性和扩展性。 