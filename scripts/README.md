# 数据库脚本使用说明

本目录包含用于数据库操作的脚本，主要用于测试和演示系统功能。

## 脚本列表

### 1. `insert_test_data.py`
通用测试数据插入脚本，包含多种类型的数据。

**功能：**
- 插入API调用记录
- 插入任务记录
- 插入敏感内容处理记录
- 生成统计信息

**使用方法：**
```bash
python scripts/insert_test_data.py
```

### 2. `insert_api_data.py`
专门用于插入API调用记录的脚本，包含真实的API调用场景。

**功能：**
- 插入真实的API调用场景数据
- 包含成功和失败的调用记录
- 包含敏感内容处理记录
- 批量插入测试数据

**使用方法：**
```bash
python scripts/insert_api_data.py
```

### 3. `query_api_data.py`
查询和显示数据库中的API调用记录。

**功能：**
- 查询最近的API调用记录
- 按服务类型查询
- 按状态查询
- 获取统计信息
- 查询敏感内容处理记录
- 查询token使用情况

**使用方法：**
```bash
python scripts/query_api_data.py
```

## 数据内容说明

### API调用记录包含：
- **任务ID**: 标识具体的处理任务
- **服务类型**: doubao, tts, volcengine等
- **API类型**: chat_completions, image_generate, video_generate等
- **状态**: success, error
- **耗时**: API调用的响应时间
- **请求数据**: 发送给API的请求内容
- **响应数据**: API返回的响应内容
- **Token使用情况**: 成功调用时的token消耗
- **错误信息**: 失败时的错误详情

### 真实场景数据包括：
1. **小说分析场景**: 使用豆包API分析小说内容
2. **图像生成场景**: 包括成功和敏感内容错误的情况
3. **视频生成场景**: 文生视频的完整流程
4. **Prompt改写场景**: 敏感内容处理
5. **TTS场景**: 文本转语音

## 使用建议

### 1. 测试环境准备
在运行脚本前，确保：
- 数据库已正确配置
- 数据库表结构已创建
- 环境变量已设置

### 2. 数据插入顺序
建议按以下顺序运行：
1. 先运行 `insert_api_data.py` 插入基础数据
2. 再运行 `insert_test_data.py` 插入补充数据
3. 最后运行 `query_api_data.py` 验证数据

### 3. 数据清理
如果需要清理测试数据，可以使用以下SQL：
```sql
-- 清理API调用记录
DELETE FROM api_calls WHERE task_id LIKE 'test_%';
DELETE FROM api_calls WHERE task_id LIKE 'novel_%';
DELETE FROM api_calls WHERE task_id LIKE 'batch_%';
```

## 注意事项

1. **数据量控制**: 脚本会插入一定数量的测试数据，请根据实际需要调整
2. **时间戳**: 数据的时间戳会设置为最近的时间范围
3. **错误处理**: 脚本包含完整的错误处理机制
4. **日志记录**: 所有操作都会记录到日志中

## 扩展功能

可以根据需要扩展脚本功能：
- 添加更多类型的测试数据
- 实现实际的数据库查询功能
- 添加数据导出功能
- 添加性能测试功能

## 故障排除

如果遇到问题：
1. 检查数据库连接配置
2. 确认数据库表结构
3. 查看日志文件获取详细错误信息
4. 确保所有依赖包已安装 